name: CEF Compatibility Check

on:
  schedule:
    # Run weekly on Monday at 09:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-and-build:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            build-essential \
            cmake \
            pkg-config \
            libfuse2

      - name: Install package dependencies
        working-directory: package
        run: bun install

      - name: Check latest stable CEF version
        id: check
        working-directory: package
        run: bun scripts/check-latest-cef.ts

      - name: Build with latest CEF
        if: steps.check.outputs.has_update == 'true'
        working-directory: package
        run: bun build.ts

      - name: Job summary
        if: always()
        run: |
          if [[ "${{ steps.check.outputs.has_update }}" != "true" ]]; then
            echo "## Result: Up to date" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "CEF \`${{ steps.check.outputs.current_cef_version }}\` is already the latest stable version. No build needed." >> "$GITHUB_STEP_SUMMARY"
          elif [[ "${{ steps.check.outcome }}" == "failure" ]]; then
            echo "## Result: Check failed" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "The version check step failed. See logs for details." >> "$GITHUB_STEP_SUMMARY"
          elif [[ "${{ job.status }}" == "success" ]]; then
            echo "## Result: Build passed" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "CEF \`${{ steps.check.outputs.latest_cef_version }}\` (Chromium \`${{ steps.check.outputs.latest_chromium_version }}\`) builds successfully against Electrobun." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## Result: Build failed" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "CEF \`${{ steps.check.outputs.latest_cef_version }}\` (Chromium \`${{ steps.check.outputs.latest_chromium_version }}\`) has breaking changes â€” build failed." >> "$GITHUB_STEP_SUMMARY"
          fi
